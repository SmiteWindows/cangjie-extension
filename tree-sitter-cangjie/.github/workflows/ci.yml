name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - '.github/**'
  pull_request:
    branches: [ main ]

# 启用并行作业
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 构建作业 - 并行执行
  build:
    runs-on: ${{ matrix.os }}-${{ matrix.arch }}
    strategy:
      matrix:
        os: [ubuntu, windows, macos]
        arch: [x64]
        include:
          - os: ubuntu
            arch: arm64
          - os: macos
            arch: arm64
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    # 设置缓存
    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          package-lock.json
        key: ${{ runner.os }}-node-${{ hashFiles('package.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ hashFiles('Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-cargo-

    - name: Read toolchain configuration for cache
      id: toolchain-cache
      run: |
        # Read wasiSdk version from toolchain.json
        toolchainContent=$(cat toolchain.json)
        wasiSdkVersion=$(echo $toolchainContent | jq -r '.versions.wasiSdk')
        nodeVersion=$(echo $toolchainContent | jq -r '.versions.node')
        treeSitterCliVersion=$(echo $toolchainContent | jq -r '.versions.treeSitterCli')
        echo "wasiSdkVersion=$wasiSdkVersion" >> $GITHUB_OUTPUT
        echo "nodeVersion=$nodeVersion" >> $GITHUB_OUTPUT
        echo "treeSitterCliVersion=$treeSitterCliVersion" >> $GITHUB_OUTPUT
      shell: bash

    - name: Cache WASI SDK
      uses: actions/cache@v4
      with:
        path: |
          /opt/wasi-sdk-${{ steps.toolchain-cache.outputs.wasiSdkVersion }}
          C:\wasi-sdk-${{ steps.toolchain-cache.outputs.wasiSdkVersion }}
        key: ${{ runner.os }}-${{ runner.arch }}-wasi-sdk-${{ steps.toolchain-cache.outputs.wasiSdkVersion }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.toolchain-cache.outputs.nodeVersion }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Read toolchain configuration
      id: toolchain
      run: |
        # Read wasiSdk version from toolchain.json
        toolchainContent=$(cat toolchain.json)
        wasiSdkVersion=$(echo $toolchainContent | jq -r '.versions.wasiSdk')
        echo "wasiSdkVersion=$wasiSdkVersion" >> $GITHUB_OUTPUT
      shell: bash

    - name: Install WASI SDK (Linux/macOS) - Cached
      if: runner.os != 'Windows' && !exists('/opt/wasi-sdk-${{ steps.toolchain.outputs.wasiSdkVersion }}')
      run: |
        # Install WASI SDK for Linux/macOS only if not cached
        wasiSdkVersion=${{ steps.toolchain.outputs.wasiSdkVersion }}
        wasiSdkMajorVersion=$(echo $wasiSdkVersion | cut -d. -f1)
        
        if [ "$RUNNER_OS" == "Linux" ]; then
          if [ "$RUNNER_ARCH" == "x64" ]; then
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-$wasiSdkMajorVersion/wasi-sdk-$wasiSdkVersion-x86_64-linux.tar.gz | tar -xzf - -C /opt
          elif [ "$RUNNER_ARCH" == "arm64" ]; then
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-$wasiSdkMajorVersion/wasi-sdk-$wasiSdkVersion-aarch64-linux.tar.gz | tar -xzf - -C /opt
          fi
        elif [ "$RUNNER_OS" == "macOS" ]; then
          if [ "$RUNNER_ARCH" == "x64" ]; then
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-$wasiSdkMajorVersion/wasi-sdk-$wasiSdkVersion-x86_64-macos.tar.gz | tar -xzf - -C /opt
          elif [ "$RUNNER_ARCH" == "arm64" ]; then
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-$wasiSdkMajorVersion/wasi-sdk-$wasiSdkVersion-aarch64-macos.tar.gz | tar -xzf - -C /opt
          fi
        fi
        echo "WASI_SDK_PATH=/opt/wasi-sdk-$wasiSdkVersion" >> $GITHUB_ENV
      shell: bash

    - name: Install WASI SDK (Windows) - Cached
      if: runner.os == 'Windows' && !exists('C:\wasi-sdk-${{ steps.toolchain.outputs.wasiSdkVersion }}')
      run: |
        # Install WASI SDK for Windows only if not cached
        $wasiSdkVersion = ${{ steps.toolchain.outputs.wasiSdkVersion }}
        $wasiSdkMajorVersion = $wasiSdkVersion.Split('.')[0]
        
        $wasiSdkUrl = "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-$wasiSdkMajorVersion/wasi-sdk-$wasiSdkVersion-mingw.tar.gz"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasi-sdk-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasiSdkFile = Join-Path -Path $tempDir -ChildPath "wasi-sdk.tar.gz"
        Invoke-WebRequest -Uri $wasiSdkUrl -OutFile $wasiSdkFile -UseBasicParsing
        
        bash -c "tar -xzf $wasiSdkFile -C $tempDir"
        $wasiSdkDir = Get-ChildItem -Path $tempDir -Name "wasi-sdk-*" | Select-Object -First 1
        $wasiSdkPath = Join-Path -Path $tempDir -ChildPath $wasiSdkDir
        
        # Move to a fixed location for caching
        $fixedWasiSdkPath = "C:\wasi-sdk-$wasiSdkVersion"
        if (-not (Test-Path -Path $fixedWasiSdkPath -PathType Container)) {
          New-Item -Path $fixedWasiSdkPath -ItemType Directory -Force | Out-Null
          Copy-Item -Path "$wasiSdkPath\*" -Destination $fixedWasiSdkPath -Recurse -Force
        }
        
        .\setup-wasi-sdk.ps1 -WasiSdkPath $fixedWasiSdkPath -Scope User
        echo "WASI_SDK_PATH=$fixedWasiSdkPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      shell: pwsh

    - name: Set WASI SDK path from cache
      if: (runner.os != 'Windows' && exists('/opt/wasi-sdk-${{ steps.toolchain.outputs.wasiSdkVersion }}')) || (runner.os == 'Windows' && exists('C:\wasi-sdk-${{ steps.toolchain.outputs.wasiSdkVersion }}'))
      run: |
        wasiSdkVersion=${{ steps.toolchain.outputs.wasiSdkVersion }}
        if [ "$RUNNER_OS" == "Windows" ]; then
          echo "WASI_SDK_PATH=C:\wasi-sdk-$wasiSdkVersion" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        else
          echo "WASI_SDK_PATH=/opt/wasi-sdk-$wasiSdkVersion" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Install tree-sitter-cli
      run: npm install -g tree-sitter-cli@${{ steps.toolchain-cache.outputs.treeSitterCliVersion }}

    - name: Generate parser
      run: tree-sitter generate

    - name: Run tree-sitter tests
      run: tree-sitter test

  # 绑定测试作业 - 并行执行
  test-bindings:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    # 设置缓存
    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          package-lock.json
        key: ${{ runner.os }}-node-${{ hashFiles('package.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ hashFiles('Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-cargo-

    - name: Read toolchain configuration
      id: toolchain
      run: |
        # Read versions from toolchain.json
        toolchainContent=$(cat toolchain.json)
        nodeVersion=$(echo $toolchainContent | jq -r '.versions.node')
        goVersion=$(echo $toolchainContent | jq -r '.versions.go')
        pythonVersion=$(echo $toolchainContent | jq -r '.versions.python')
        treeSitterCliVersion=$(echo $toolchainContent | jq -r '.versions.treeSitterCli')
        echo "nodeVersion=$nodeVersion" >> $GITHUB_OUTPUT
        echo "goVersion=$goVersion" >> $GITHUB_OUTPUT
        echo "pythonVersion=$pythonVersion" >> $GITHUB_OUTPUT
        echo "treeSitterCliVersion=$treeSitterCliVersion" >> $GITHUB_OUTPUT
      shell: bash

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.toolchain.outputs.nodeVersion }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ steps.toolchain.outputs.goVersion }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ steps.toolchain.outputs.pythonVersion }}

    - name: Set up Swift (macOS only)
      if: runner.os == 'macOS'
      run: |
        # Swift is pre-installed on macOS GitHub runners
        swift --version
      shell: bash

    - name: Install tree-sitter-cli
      run: npm install -g tree-sitter-cli

    - name: Generate parser
      run: tree-sitter generate

    # 并行运行各种绑定测试
    - name: Run Rust tests
      run: cargo test

    - name: Run Go binding tests
      run: go test ./bindings/go -v

    - name: Run Python binding tests
      run: |
        pip install tree-sitter
        python -m pytest bindings/python/tests/test_binding.py -v
      shell: bash

    - name: Run Swift binding tests (macOS only)
      if: runner.os == 'macOS'
      run: swift test --package-path bindings/swift
      shell: bash

    - name: Test WASM with Wasmtime
      run: |
        # Use project script to test WASM module
        if [ "$RUNNER_OS" == "Windows" ]; then
          # On Windows, use PowerShell
          pwsh -ExecutionPolicy Bypass -File .\test-wasm-module.ps1 -InstallWasmtime
        else
          # On Linux/macOS, use bash to call PowerShell script
          pwsh -ExecutionPolicy Bypass -File ./test-wasm-module.ps1 -InstallWasmtime
        fi
      shell: bash

  # 静态分析作业 - 并行执行
  static-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Read toolchain configuration
      id: toolchain
      run: |
        # Read versions from toolchain.json
        toolchainContent=$(cat toolchain.json)
        nodeVersion=$(echo $toolchainContent | jq -r '.versions.node')
        echo "nodeVersion=$nodeVersion" >> $GITHUB_OUTPUT
      shell: bash

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.toolchain.outputs.nodeVersion }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        components: clippy, rustfmt

    - name: Install dependencies
      run: npm install

    - name: Run Rustfmt
      run: cargo fmt --all --check

    - name: Run Clippy
      run: cargo clippy --all -- -D warnings

  # 增量构建测试
  incremental-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    # 设置缓存
    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          package-lock.json
        key: ${{ runner.os }}-node-${{ hashFiles('package.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ hashFiles('Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-cargo-

    - name: Read toolchain configuration
      id: toolchain
      run: |
        # Read versions from toolchain.json
        toolchainContent=$(cat toolchain.json)
        nodeVersion=$(echo $toolchainContent | jq -r '.versions.node')
        treeSitterCliVersion=$(echo $toolchainContent | jq -r '.versions.treeSitterCli')
        echo "nodeVersion=$nodeVersion" >> $GITHUB_OUTPUT
        echo "treeSitterCliVersion=$treeSitterCliVersion" >> $GITHUB_OUTPUT
      shell: bash

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.toolchain.outputs.nodeVersion }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Install tree-sitter-cli
      run: npm install -g tree-sitter-cli@${{ steps.toolchain.outputs.treeSitterCliVersion }}

    - name: Initial build
      run: tree-sitter generate

    - name: Make a small change to trigger incremental build
      run: echo "// Test comment" >> grammar.js

    - name: Incremental build
      run: tree-sitter generate

    - name: Verify incremental build worked
      run: git diff --exit-code --name-only | grep -v "grammar.js" || echo "No unexpected files changed"