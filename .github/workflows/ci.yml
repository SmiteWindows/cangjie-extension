name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true



    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Install WASI SDK (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Install WASI SDK for Linux/macOS
        curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-linux.tar.gz | tar -xzf - -C /opt
        echo "WASI_SDK_PATH=/opt/wasi-sdk-29.0" >> $GITHUB_ENV
      shell: bash

    - name: Install WASI SDK (Windows)
      if: runner.os == 'Windows'
      run: |
        # Install WASI SDK for Windows
        $wasiSdkUrl = "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-mingw.tar.gz"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasi-sdk-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasiSdkFile = Join-Path -Path $tempDir -ChildPath "wasi-sdk.tar.gz"
        Invoke-WebRequest -Uri $wasiSdkUrl -OutFile $wasiSdkFile -UseBasicParsing
        
        # Extract using tar (available in Git Bash on Windows GitHub Actions)
        bash -c "tar -xzf $wasiSdkFile -C $tempDir"
        $wasiSdkDir = Get-ChildItem -Path $tempDir -Name "wasi-sdk-*" | Select-Object -First 1
        $wasiSdkPath = Join-Path -Path $tempDir -ChildPath $wasiSdkDir
        echo "WASI_SDK_PATH=$wasiSdkPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      shell: pwsh

    - name: Install Wasmtime (Linux)
      if: runner.os == 'Linux'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (macOS)
      if: runner.os == 'macOS'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (Windows)
      if: runner.os == 'Windows'
      run: |
        $wasmtimeUrl = "https://github.com/bytecodealliance/wasmtime/releases/download/v20.0.0/wasmtime-v20.0.0-x86_64-windows.zip"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasmtime-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasmtimeFile = Join-Path -Path $tempDir -ChildPath "wasmtime.zip"
        Invoke-WebRequest -Uri $wasmtimeUrl -OutFile $wasmtimeFile -UseBasicParsing
        
        Expand-Archive -Path $wasmtimeFile -DestinationPath $tempDir -Force
        $wasmtimeDir = Get-ChildItem -Path $tempDir -Name "wasmtime-*" | Select-Object -First 1
        $wasmtimePath = Join-Path -Path $tempDir -ChildPath $wasmtimeDir
        echo "$wasmtimePath" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Build tree-sitter grammar
      run: npm run build-grammar

    - name: Run tree-sitter tests
      run: npm run test

  test-bindings:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Set up Swift (macOS only)
      if: runner.os == 'macOS'
      run: |
        # Swift is pre-installed on macOS GitHub runners
        swift --version
      shell: bash

    - name: Install WASI SDK (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Install WASI SDK for Linux/macOS
        curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-linux.tar.gz | tar -xzf - -C /opt
        echo "WASI_SDK_PATH=/opt/wasi-sdk-29.0" >> $GITHUB_ENV
      shell: bash

    - name: Install WASI SDK (Windows)
      if: runner.os == 'Windows'
      run: |
        # Install WASI SDK for Windows
        $wasiSdkUrl = "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-mingw.tar.gz"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasi-sdk-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasiSdkFile = Join-Path -Path $tempDir -ChildPath "wasi-sdk.tar.gz"
        Invoke-WebRequest -Uri $wasiSdkUrl -OutFile $wasiSdkFile -UseBasicParsing
        
        # Extract using tar (available in Git Bash on Windows GitHub Actions)
        bash -c "tar -xzf $wasiSdkFile -C $tempDir"
        $wasiSdkDir = Get-ChildItem -Path $tempDir -Name "wasi-sdk-*" | Select-Object -First 1
        $wasiSdkPath = Join-Path -Path $tempDir -ChildPath $wasiSdkDir
        echo "WASI_SDK_PATH=$wasiSdkPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      shell: pwsh

    - name: Install Wasmtime (Linux)
      if: runner.os == 'Linux'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (macOS)
      if: runner.os == 'macOS'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (Windows)
      if: runner.os == 'Windows'
      run: |
        $wasmtimeUrl = "https://github.com/bytecodealliance/wasmtime/releases/download/v20.0.0/wasmtime-v20.0.0-x86_64-windows.zip"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasmtime-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasmtimeFile = Join-Path -Path $tempDir -ChildPath "wasmtime.zip"
        Invoke-WebRequest -Uri $wasmtimeUrl -OutFile $wasmtimeFile -UseBasicParsing
        
        Expand-Archive -Path $wasmtimeFile -DestinationPath $tempDir -Force
        $wasmtimeDir = Get-ChildItem -Path $tempDir -Name "wasmtime-*" | Select-Object -First 1
        $wasmtimePath = Join-Path -Path $tempDir -ChildPath $wasmtimeDir
        echo "$wasmtimePath" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Build tree-sitter grammar (including WASM)
      run: npm run build-grammar

    - name: Run Rust tests
      run: npm run test-rust

    - name: Test WASM with Wasmtime
      run: |
        # Verify wasmtime is installed
        wasmtime --version
        
        # Check if WASM file exists
        ls -la tree-sitter-cangjie/target/wasm32-wasip2/release/
        
        # Run basic validation of the WASM module
        wasmtime validate tree-sitter-cangjie/target/wasm32-wasip2/release/tree_sitter_cangjie.wasm
      shell: bash

    - name: Run Go binding tests
      run: |
        cd tree-sitter-cangjie
        go test ./bindings/go -v
      shell: bash

    - name: Run Python binding tests
      run: |
        cd tree-sitter-cangjie
        pip install tree-sitter
        python -m pytest bindings/python/tests/test_binding.py -v
      shell: bash

    - name: Run Swift binding tests (macOS only)
      if: runner.os == 'macOS'
      run: |
        cd tree-sitter-cangjie
        swift test --package-path bindings/swift
      shell: bash

    - name: Install Cangjie SDK (Optional)
      continue-on-error: true
      run: |
        Write-Host "Installing Cangjie SDK..."
        
        $sdkUrl = "https://cangjie-lang.cn/download/1.0.4"
        # Use the correct temporary directory variable based on the OS
        if ($env:RUNNER_OS -eq "Windows") {
            $tempPath = $env:TEMP
        } else {
            if ([string]::IsNullOrEmpty($env:TMPDIR)) {
                $tempPath = "/tmp"
            } else {
                $tempPath = $env:TMPDIR
            }
        }
        $tempDir = Join-Path -Path $tempPath -ChildPath "cangjie-sdk-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        
        try {
          if ($env:RUNNER_OS -eq "Linux") {
            # Linux installation
            Write-Host "Linux installation detected"
            
            # Check if required commands exist
            if (-not (Get-Command wget -ErrorAction SilentlyContinue)) {
              Write-Error "wget command not found, please install wget first"
              exit 1
            }
            if (-not (Get-Command tar -ErrorAction SilentlyContinue)) {
              Write-Error "tar command not found, please install tar first"
              exit 1
            }
            
            $sdkFile = Join-Path -Path $tempDir -ChildPath "cangjie-sdk.tar.gz"
            Write-Host "Downloading SDK from $sdkUrl to $sdkFile"
            wget -q $sdkUrl -O $sdkFile
            
            $installDir = "/usr/local/cangjie"
            Write-Host "Creating installation directory: $installDir"
            sudo mkdir -p $installDir
            sudo chmod 755 $installDir
            
            Write-Host "Extracting SDK to $installDir"
            sudo tar -xzf $sdkFile -C $installDir --strip-components=1
            
            Write-Host "Setting environment variables"
            "CANGJIE_HOME=$installDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            "$installDir/bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
            
            Write-Host "Linux SDK installation completed successfully"
          } elseif ($env:RUNNER_OS -eq "macOS") {
            # macOS installation
            Write-Host "macOS installation detected"
            
            # Check if required commands exist
            if (-not (Get-Command curl -ErrorAction SilentlyContinue)) {
              Write-Error "curl command not found, please install curl first"
              exit 1
            }
            if (-not (Get-Command tar -ErrorAction SilentlyContinue)) {
              Write-Error "tar command not found, please install tar first"
              exit 1
            }
            
            $sdkFile = Join-Path -Path $tempDir -ChildPath "cangjie-sdk.tar.gz"
            Write-Host "Downloading SDK from $sdkUrl to $sdkFile"
            curl -s -L $sdkUrl -o $sdkFile
            
            $installDir = "/usr/local/cangjie"
            Write-Host "Creating installation directory: $installDir"
            sudo mkdir -p $installDir
            sudo chmod 755 $installDir
            
            Write-Host "Extracting SDK to $installDir"
            sudo tar -xzf $sdkFile -C $installDir --strip-components=1
            
            Write-Host "Setting environment variables"
            "CANGJIE_HOME=$installDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            "$installDir/bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
            
            Write-Host "macOS SDK installation completed successfully"
          } elseif ($env:RUNNER_OS -eq "Windows") {
            # Windows installation
            Write-Host "Windows installation detected"
            
            $sdkFile = Join-Path -Path $tempDir -ChildPath "cangjie-sdk.zip"
            Write-Host "Downloading SDK from $sdkUrl to $sdkFile"
            Invoke-WebRequest -Uri $sdkUrl -OutFile $sdkFile -UseBasicParsing
            
            $installDir = "C:\Program Files\Cangjie"
            Write-Host "Creating installation directory: $installDir"
            New-Item -Path $installDir -ItemType Directory -Force | Out-Null
            
            Write-Host "Extracting SDK to $installDir"
            Expand-Archive -Path $sdkFile -DestinationPath $installDir -Force
            
            Write-Host "Setting environment variables"
            "CANGJIE_HOME=$installDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            "$installDir\bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
            
            Write-Host "Windows SDK installation completed successfully"
          } else {
            Write-Error "Unsupported operating system: $env:RUNNER_OS"
            exit 1
          }
        } catch {
          Write-Warning "SDK installation failed: $($_.Exception.Message)"
          Write-Warning "SDK installation is optional, continuing with the build..."
        } finally {
          # Clean up temporary directory
          Write-Host "Cleaning up temporary directory: $tempDir"
          Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
        }
      shell: pwsh
