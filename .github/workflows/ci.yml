name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Cangjie SDK
      run: |
        Write-Host "Installing Cangjie SDK..."
        
        $sdkUrl = "https://cangjie-lang.cn/download/1.0.4"
        
        if ($env:RUNNER_OS -eq "Linux") {
          # Linux installation
          wget -q $sdkUrl -O cangjie-sdk.tar.gz
          mkdir -p /usr/local/cangjie
          tar -xzf cangjie-sdk.tar.gz -C /usr/local/cangjie --strip-components=1
          "CANGJIE_HOME=/usr/local/cangjie" | Out-File -FilePath $env:GITHUB_ENV -Append
          "/usr/local/cangjie/bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        } elseif ($env:RUNNER_OS -eq "macOS") {
          # macOS installation
          curl -s -L $sdkUrl -o cangjie-sdk.tar.gz
          mkdir -p /usr/local/cangjie
          tar -xzf cangjie-sdk.tar.gz -C /usr/local/cangjie --strip-components=1
          "CANGJIE_HOME=/usr/local/cangjie" | Out-File -FilePath $env:GITHUB_ENV -Append
          "/usr/local/cangjie/bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        } elseif ($env:RUNNER_OS -eq "Windows") {
          # Windows installation
          Invoke-WebRequest -Uri $sdkUrl -OutFile "cangjie-sdk.zip"
          Expand-Archive -Path "cangjie-sdk.zip" -DestinationPath "C:\Program Files\Cangjie" -Force
          "CANGJIE_HOME=C:\Program Files\Cangjie" | Out-File -FilePath $env:GITHUB_ENV -Append
          "C:\Program Files\Cangjie\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        }
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Build tree-sitter grammar
      run: npm run build-grammar

    - name: Run tree-sitter tests
      run: npm run test

  build-rust:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true

    - name: Run Rust tests
      run: npm run test-rust
