name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}-${{ matrix.arch }}
    strategy:
      matrix:
        os: [ubuntu, windows, macos]
        arch: [x64]
        include:
          - os: ubuntu
            arch: arm64
          - os: macos
            arch: arm64

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true



    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Install WASI SDK (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Install WASI SDK for Linux/macOS
        if [ "$RUNNER_OS" == "Linux" ]; then
          if [ "$RUNNER_ARCH" == "x64" ]; then
            # For Linux x86_64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-x86_64-linux.tar.gz | tar -xzf - -C /opt
          elif [ "$RUNNER_ARCH" == "arm64" ]; then
            # For Linux arm64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-aarch64-linux.tar.gz | tar -xzf - -C /opt
          fi
        elif [ "$RUNNER_OS" == "macOS" ]; then
          if [ "$RUNNER_ARCH" == "x64" ]; then
            # For macOS x86_64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-x86_64-macos.tar.gz | tar -xzf - -C /opt
          elif [ "$RUNNER_ARCH" == "arm64" ]; then
            # For macOS arm64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-aarch64-macos.tar.gz | tar -xzf - -C /opt
          fi
        fi
        echo "WASI_SDK_PATH=/opt/wasi-sdk-29.0" >> $GITHUB_ENV
      shell: bash

    - name: Install WASI SDK (Windows)
      if: runner.os == 'Windows'
      run: |
        # Install WASI SDK for Windows
        $wasiSdkUrl = "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-mingw.tar.gz"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasi-sdk-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasiSdkFile = Join-Path -Path $tempDir -ChildPath "wasi-sdk.tar.gz"
        Invoke-WebRequest -Uri $wasiSdkUrl -OutFile $wasiSdkFile -UseBasicParsing
        
        # Extract using tar (available in Git Bash on Windows GitHub Actions)
        bash -c "tar -xzf $wasiSdkFile -C $tempDir"
        $wasiSdkDir = Get-ChildItem -Path $tempDir -Name "wasi-sdk-*" | Select-Object -First 1
        $wasiSdkPath = Join-Path -Path $tempDir -ChildPath $wasiSdkDir
        
        # Use project script to set WASI SDK path
        .\setup-wasi-sdk.ps1 -WasiSdkPath $wasiSdkPath -Scope User
        echo "WASI_SDK_PATH=$wasiSdkPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      shell: pwsh

    - name: Install Wasmtime (Linux)
      if: runner.os == 'Linux'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (macOS)
      if: runner.os == 'macOS'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (Windows)
      if: runner.os == 'Windows'
      run: |
        $wasmtimeUrl = "https://github.com/bytecodealliance/wasmtime/releases/download/v20.0.0/wasmtime-v20.0.0-x86_64-windows.zip"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasmtime-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasmtimeFile = Join-Path -Path $tempDir -ChildPath "wasmtime.zip"
        Invoke-WebRequest -Uri $wasmtimeUrl -OutFile $wasmtimeFile -UseBasicParsing
        
        Expand-Archive -Path $wasmtimeFile -DestinationPath $tempDir -Force
        $wasmtimeDir = Get-ChildItem -Path $tempDir -Name "wasmtime-*" | Select-Object -First 1
        $wasmtimePath = Join-Path -Path $tempDir -ChildPath $wasmtimeDir
        echo "$wasmtimePath" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Build tree-sitter grammar
      run: npm run build-grammar

    - name: Run tree-sitter tests
      run: npm run test

  test-bindings:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        override: true
        targets: wasm32-wasip2, wasm32-unknown-unknown

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Set up Swift (macOS only)
      if: runner.os == 'macOS'
      run: |
        # Swift is pre-installed on macOS GitHub runners
        swift --version
      shell: bash

    - name: Install WASI SDK (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Install WASI SDK for Linux/macOS
        if [ "$RUNNER_OS" == "Linux" ]; then
          if [ "$RUNNER_ARCH" == "x64" ]; then
            # For Linux x86_64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-x86_64-linux.tar.gz | tar -xzf - -C /opt
          elif [ "$RUNNER_ARCH" == "arm64" ]; then
            # For Linux arm64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-aarch64-linux.tar.gz | tar -xzf - -C /opt
          fi
        elif [ "$RUNNER_OS" == "macOS" ]; then
          if [ "$RUNNER_ARCH" == "x64" ]; then
            # For macOS x86_64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-x86_64-macos.tar.gz | tar -xzf - -C /opt
          elif [ "$RUNNER_ARCH" == "arm64" ]; then
            # For macOS arm64
            curl -sSfL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-aarch64-macos.tar.gz | tar -xzf - -C /opt
          fi
        fi
        echo "WASI_SDK_PATH=/opt/wasi-sdk-29.0" >> $GITHUB_ENV
      shell: bash

    - name: Install WASI SDK (Windows)
      if: runner.os == 'Windows'
      run: |
        # Install WASI SDK for Windows
        $wasiSdkUrl = "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-29/wasi-sdk-29.0-mingw.tar.gz"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasi-sdk-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasiSdkFile = Join-Path -Path $tempDir -ChildPath "wasi-sdk.tar.gz"
        Invoke-WebRequest -Uri $wasiSdkUrl -OutFile $wasiSdkFile -UseBasicParsing
        
        # Extract using tar (available in Git Bash on Windows GitHub Actions)
        bash -c "tar -xzf $wasiSdkFile -C $tempDir"
        $wasiSdkDir = Get-ChildItem -Path $tempDir -Name "wasi-sdk-*" | Select-Object -First 1
        $wasiSdkPath = Join-Path -Path $tempDir -ChildPath $wasiSdkDir
        
        # Use project script to set WASI SDK path
        .\setup-wasi-sdk.ps1 -WasiSdkPath $wasiSdkPath -Scope User
        echo "WASI_SDK_PATH=$wasiSdkPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      shell: pwsh

    - name: Install Wasmtime (Linux)
      if: runner.os == 'Linux'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (macOS)
      if: runner.os == 'macOS'
      run: |
        curl -sSf https://wasmtime.dev/install.sh | bash
        echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install Wasmtime (Windows)
      if: runner.os == 'Windows'
      run: |
        $wasmtimeUrl = "https://github.com/bytecodealliance/wasmtime/releases/download/v20.0.0/wasmtime-v20.0.0-x86_64-windows.zip"
        $tempDir = Join-Path -Path $env:TEMP -ChildPath "wasmtime-$(Get-Random)"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $wasmtimeFile = Join-Path -Path $tempDir -ChildPath "wasmtime.zip"
        Invoke-WebRequest -Uri $wasmtimeUrl -OutFile $wasmtimeFile -UseBasicParsing
        
        Expand-Archive -Path $wasmtimeFile -DestinationPath $tempDir -Force
        $wasmtimeDir = Get-ChildItem -Path $tempDir -Name "wasmtime-*" | Select-Object -First 1
        $wasmtimePath = Join-Path -Path $tempDir -ChildPath $wasmtimeDir
        echo "$wasmtimePath" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Build tree-sitter grammar (including WASM)
      run: npm run build-grammar

    - name: Run Rust tests
      run: npm run test-rust

    - name: Test WASM with Wasmtime
      run: |
        # Use project script to test WASM module
        if [ "$RUNNER_OS" == "Windows" ]; then
          # On Windows, use PowerShell
          pwsh -ExecutionPolicy Bypass -File .\test-wasm-module.ps1 -InstallWasmtime
        else
          # On Linux/macOS, use bash to call PowerShell script
          # Note: PowerShell 7 is required, which is pre-installed on GitHub runners
          pwsh -ExecutionPolicy Bypass -File ./test-wasm-module.ps1 -InstallWasmtime
        fi
      shell: bash

    - name: Run Go binding tests
      run: |
        cd tree-sitter-cangjie
        go test ./bindings/go -v
      shell: bash

    - name: Run Python binding tests
      run: |
        cd tree-sitter-cangjie
        pip install tree-sitter
        python -m pytest bindings/python/tests/test_binding.py -v
      shell: bash

    - name: Run Swift binding tests (macOS only)
      if: runner.os == 'macOS'
      run: |
        cd tree-sitter-cangjie
        swift test --package-path bindings/swift
      shell: bash

    - name: Install Cangjie SDK (Optional)
      continue-on-error: true
      run: |
        # Use project script to install Cangjie SDK
        if [ "$RUNNER_OS" == "Windows" ]; then
          # On Windows, use PowerShell
          pwsh -ExecutionPolicy Bypass -File .\setup-cangjie-sdk.ps1 -Force -Silent
        else
          # On Linux/macOS, use bash to call PowerShell script
          pwsh -ExecutionPolicy Bypass -File ./setup-cangjie-sdk.ps1 -Force -Silent
        fi
      shell: bash
